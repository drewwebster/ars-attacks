<html>

<head>
  <meta charset="utf-8">
  <title>ARs Attacks!</title>
  <script src="https://aframe.io/releases/0.8.2/aframe.min.js"></script>
  <script src="https://unpkg.com/networked-aframe/dist/networked-aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-randomizer-components@^3.0.1/dist/aframe-randomizer-components.min.js"></script>
  <script src="//cdn.rawgit.com/donmccurdy/aframe-physics-system/v3.1.2/dist/aframe-physics-system.min.js"></script>
  <script src="https://unpkg.com/aframe-physics-extras/dist/aframe-physics-extras.min.js"></script>
  <script src="https://rawgit.com/feiss/aframe-environment-component/master/dist/aframe-environment-component.min.js"></script>
  <script src="js/aframe-state-component.js"></script>
  <script src="./js/three.ar.js"></script>
  <script src="./js/aframe-ar.js"></script>
  <script src="/js/spawn-in-circle.component.js"></script>
  <script src="/js/grid-shader.js"></script>

  <!-- Include polygon component. -->
  <script src="/js/polygon.js"></script>
        
  <!-- Prevent touch causing flicker on iOS. -->
  <style> * { -webkit-tap-highlight-color: rgba(0,0,0,0); } </style>  
  <script src="/js/game-state.js"></script>
  <script src="./js/projectile.js"></script>
  <script src="./js/shooter.js"></script>
  <script src="./js/target.js"></script>
  <script src="./js/oculus-go-controls.js"></script>
  <script src="/js/html-imports.min.js"></script>
  <link rel="import" href="templates.html">
</head>

<body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.5/socket.io.min.js"></script>
  <script src="/easyrtc/easyrtc.js"></script>
  <script src="/js/planes-example.js"></script>   
  <a-scene ar networked-scene="
      room: dev;
      debug: true;
      adapter: wseasyrtc;
     "
    physics="gravity: 0"
    environment="preset:yavapai">

    <!-- When we have a raycaster hit, we use this ball to show where. -->
    <a-sphere id="ball" radius="0.01" position="0 0.005 -0.5"></a-sphere>

    <a-entity position="0 10 0" scale="5 5 5"
      networked="template:#ar-template;attachTemplateToLocal:false;">
      <a-camera id="player" class="avatar"
        scale="1 1 1" position="0 0 0" rotation="0 0 0"
        target shooter="team: alien"
        static-body="shape: sphere; sphereRadius: 0.5" physics-collider="ignoreSleep: true"
        collision-filter="group: you; collidesWith: projectiles, alienBullets, humanBullets; collisionForces: false">
        <a-sphere class="head" visible="false" random-color></a-sphere>
      </a-camera>
  </a-entity>
    <a-assets>
      <img id="grid" src="https://i.imgur.com/25P1geh.png" crossorigin="anonymous">
      <a-mixin id="projectile-mixin" geometry="primitive: sphere; radius: 0.05"></a-mixin>
      <a-asset-item id="alien" src="/assets/atat-alien/scene.gltf"></a-asset-item>
      <a-asset-item id="ufo" src="/assets/low-poly-ufo/scene.gltf"></a-asset-item>
      <a-asset-item id="base" src="/assets/base/scene.gltf"></a-asset-item>
      <a-asset-item id="man-in-black" src="/assets/man-in-black/scene.gltf"></a-asset-item>

      <img id="waitfortemplates" />
    </a-assets>
    <!-- <a-entity gltf-model="#alien" position="0 -2 -1" scale="0.25 0.25 0.25"></a-entity>
    <a-entity gltf-model="#ufo" scale="0.05 0.05 0.05"></a-entity> -->
    <a-entity gltf-model="#base" scale="5 5 5"></a-entity>
    <!-- <a-entity gltf-model="#man-in-black"></a-entity> -->

    <!-- <a-entity id="player" networked="template:#avatar-template;attachTemplateToLocal:false;"
      camera spawn-in-circle="radius:10"
      position="0 1.6 0"
      wasd-controls look-controls
      target
      static-body="shape: sphere; sphereRadius: 0.5" physics-collider="ignoreSleep: true"
      collision-filter="group: players; collidesWith: projectiles; collisionForces: false">
      <a-sphere class="head" visible="false" random-color></a-sphere>
    </a-entity> -->

    <a-entity text="side: double; width: 10; wrapCount: 20;" position="3.2 3 -5.14" bind__text="value: life;"></a-entity>

    <a-entity position="0 0 0" geometry="primitive: plane; width: 10000; height: 10000;" rotation="-90 0 0" material="src: #grid; repeat: 10000 10000; transparent: true; metalness:0.6; roughness: 0.4;"
      static-body collision-filter="collidesWith: projectiles, alienBullets, humanBullets"></a-entity>

    <a-entity light="color: #ccccff; intensity: 1; type: ambient;" visible=""></a-entity>
    <a-entity light="color: #ffaaff; intensity: 1.5" position="5 5 5"></a-entity>
  </a-scene>
  <script src="js/naf-templates-schemas.js"></script>
  <script>
    // Called by Networked-Aframe when connected to server
    function onConnect() {
      console.log("onConnect", new Date());
    }

    function increasePointsExample() {
      AFRAME.scenes[0].emit('increaseScore', { points: 50 });
    }
  </script>
  <script>
      var sc = document.querySelector('a-scene');
      var ball = document.querySelector('#ball');
      // function showHUD(msg) { sc.querySelector('#hud').setAttribute('value', msg); }
      
      function addARRaycasterListeners() {
        var raycaster = sc.querySelector('[ar-raycaster]');
        // Note, -intersection is what the raycaster gets; the hit object gets -intersected.
        raycaster.addEventListener('raycaster-intersection', function (evt) {
          // Use first hit (which should be nearest).
          var point = evt.detail.intersections[0].point;
          var distance = evt.detail.intersections[0].distance;
          var el = evt.detail.els[0];
          // showHUD('raycaster-intersection ' + distance + '\n' + JSON.stringify(point) + '\n' + el.id /*el.outerHTML*/);
          if (el.getAttribute('class') === 'plane') { el.setAttribute('opacity', 1.0); }
          ball.setAttribute('position', point);
          ball.setAttribute('visible', true);
        });
        raycaster.addEventListener('raycaster-intersection-cleared', function (evt) {
///////////////////////////////////////////////////////////////////////////////////
// NOTE: for A-Frame 0.8.x, only one event with all cleared elements in clearedEls
//          
          var el = evt.detail.el || evt.detail.clearedEls[0];
//          
///////////////////////////////////////////////////////////////////////////////////
          // showHUD('raycaster-intersection-cleared\n' + el.outerHTML);
          if (el.getAttribute('class') === 'plane') { el.setAttribute('opacity', 0.5); }
          ball.setAttribute('visible', false);
        });
/////////////////////////////////////////////////////////////////////////////////////////
// NOTE: for A-Frame 0.8.x, we need to listen for cursor intersection changes separately
//        
        raycaster.addEventListener('cursor-intersection-changed', function (evt) {
          if (evt.detail) {
            // Use provided hit.
            var point = evt.detail.point;
            var distance = evt.detail.distance;
            var el = evt.detail.object.el;
            // showHUD('cursor-intersection-changed ' + distance + '\n' + JSON.stringify(point) + '\n' + el.id /*el.outerHTML*/);
            if (el.getAttribute('class') === 'plane') { el.setAttribute('opacity', 1.0); }
            ball.setAttribute('position', point);
            ball.setAttribute('visible', true);
          }
        });
//
/////////////////////////////////////////////////////////////////////////////////////////
      }
      
      function addEventListeners() {
        addARRaycasterListeners();
        addPlaneListeners();
      }      
      
      function onSceneLoaded() { 
        var tempPos = new THREE.Vector3();
        var tempQuat = new THREE.Quaternion();
        var tempScale = new THREE.Vector3();
        var tempEuler = new THREE.Euler(0, 0, 0, 'YXZ');
        var tempMat4 = new THREE.Matrix4();

        document.querySelector('a-sky').setAttribute('visible', false);
        
/////////////////////////////////////////////////////////////////////////////////////////
// NOTE: first surprise with master, we never get window click anymore? worked around.
// NOTE: second surprise with master, we have no cursor intersection... fixed!
//        
        window.addEventListener('touchstart'/*'click'*/, function() {
//          
/////////////////////////////////////////////////////////////////////////////////////////

          // If the cursor has an intersection, place a marker.
          var cursor = sc.querySelector('[ar-raycaster]').components.cursor;
          if (cursor.intersection) {
            var marker = document.createElement('a-box');
            marker.setAttribute('width', 0.01);
            marker.setAttribute('depth', 0.01);
            marker.setAttribute('height', 1);
            marker.setAttribute('color', 'orange');
            marker.setAttribute('position', {
              x: cursor.intersection.point.x, 
              y: cursor.intersection.point.y + 0.5, 
              z: cursor.intersection.point.z});
            sc.appendChild(marker);         
          }
          
          // Show plane info on click.
          // (may not have arDisplay until tick after loaded)
          var ardisplay = sc.components['three-ar'].arDisplay;
          if (!ardisplay) { /*showHUD('no ardisplay?');*/ } else {
            // Old versions of WebARonARKit don't expose getPlanes() correctly.
            var planes = ardisplay.getPlanes ? ardisplay.getPlanes() : ardisplay.anchors_;

            var keys = Object.keys(sc.components['ar-planes'].planes);
            var msg = planes.length + ' (vs. ' + keys.length + ': ' + keys.join(',') + ')\n\n';
/*           
            planes.forEach(function (plane) {
              // Decompose into pos / quat / scale, and make euler.
              tempMat4.fromArray(plane.modelMatrix);
              tempMat4.decompose(tempPos, tempQuat, tempScale);
              tempEuler.setFromQuaternion(tempQuat);

              // Write out what we got, for debugging.
              msg += 
              'identifier: ' + plane.identifier + '' + // string, per latest spec
              ' ' + JSON.stringify(tempPos) + ''
              ' ' + JSON.stringify(tempEuler.toVector3().multiplyScalar(THREE.Math.RAD2DEG)) + '' + 
              ' ' + plane.extent + '\n' + // number[2], per latest spec
              (plane.vertices ? ('vertices: ' + plane.vertices.length + '\n') : '') + // number[3*n], per latest spec
              '';
            });
*/            
            // showHUD(msg);
          }
        });
        
        addEventListeners();
      }
      
      if (sc.hasLoaded) { onSceneLoaded(); }
      else { sc.addEventListener('loaded', onSceneLoaded); }
    </script>
 </body>

</html>